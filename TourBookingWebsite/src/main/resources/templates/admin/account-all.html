<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Danh Sách Tài Khoản</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link type="text/css" href="/css/navBar.css" rel="stylesheet" />
<style>
    body {
        background-color: #f8f9fa;
    }
    h1 {
        margin-bottom: 30px;
        color: #343a40;
        font-family: 'Roboto', sans-serif;
    }
    .container {
        margin-top: 25px;
    }
    .filter-section {
        margin-bottom: 20px;
    }
    .filter-section input {
        width: 50%;
    }
    .filter-section select {
        width: 200px;
    }
    .input-group {
        width: 400px;
    }
    .table-responsive {
        max-height: 400px; 
        overflow-y: auto; 
        border: 1px solid #dee2e6; 
    }
    .table {
        margin-bottom: 0; 
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        border-radius: 0.5rem;
    }
    thead th {
        background-color: #007bff; 
        color: #ffffff; 
        font-weight: bold;
        position: sticky; 
        top: 0; 
        z-index: 10; 
    }
    tbody td {
        background-color: #ffffff;
        color: #343a40;
    }
    .alert {
        display: none; 
        position: fixed; 
        top: 20px; 
        right: 20px; 
        z-index: 1051; 
    }

    /* Đặt z-index cho backdrop */
    .modal-backdrop {
        z-index: 1040; /* Đảm bảo z-index của backdrop thấp hơn modal */
    }

    /* Đặt z-index cho các modal */
    #editModal {
        z-index: 1050; /* Giá trị thấp hơn các modal xác nhận */
    }

    #confirmSaveModal,
    #confirmDeleteModal {
        z-index: 1060; /* Gía trị lớn hơn để hiển thị trên editModal */
    }
</style>


</head>
<body>
    <div th:replace="MenuAdmin :: navbar"></div>

    <!-- Modal Xác Nhận Xóa Tài Khoản -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">Xác Nhận Xóa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Bạn có chắc chắn muốn xóa tài khoản này không?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteButton">Xóa</button>
                </div>
            </div>
        </div>
    </div>

<!-- Modal Xác Nhận Lưu Thay Đổi -->
<div class="modal fade" id="confirmSaveModal" tabindex="-1" role="dialog" aria-labelledby="confirmSaveModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmSaveModalLabel">Xác Nhận Lưu Thay Đổi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Bạn có chắc chắn muốn lưu thay đổi này không?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="confirmSaveButton">Lưu</button>
            </div>
        </div>
    </div>
</div>


    <div class="container">
        <div class="text-center">
            <h1>Danh Sách Tài Khoản</h1>
        </div>

        <div class="filter-section mb-3">
		    <form class="row g-2" id="searchForm" onsubmit="return false;">
		        <div class="col-md-8">
		            <div class="input-group">
		                <input class="form-control" type="text" id="searchInput" placeholder="Tìm kiếm theo tên tài khoản..." aria-label="Search" oninput="filterAccounts()">
		                <button type="button" class="btn btn-primary" onclick="filterAccounts()">Tìm kiếm</button>
		                <button type="button" class="btn btn-success ms-2" data-bs-toggle="modal" data-bs-target="#addModal">Thêm</button> <!-- Nút Thêm -->
		            </div>
		        </div>
		    </form>
		</div>


        <div class="filter-section mb-3">
            <select class="form-select" id="statusFilter" onchange="filterAccounts()">
                <option value="">Tất cả</option>
                <option value="1">Hoạt động</option>
                <option value="0">Ngưng hoạt động</option>
            </select>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-hover text-center">
                <thead>
                    <tr>
                        <th>Mã Tài Khoản</th>
                        <th>Tên Tài Khoản</th>
                        <th>Email</th>
                        <th>Trạng Thái</th>
                        <th>Hành Động</th>
                    </tr>
                </thead>
                <tbody id="table-content">
                    <tr th:each="account, index : ${accounts}">
                        <td th:text="${account.accountId}">1</td>
                        <td th:text="${account.accountName}">Tên Tài Khoản</td>
                        <td th:text="${account.email}">Email</td>
                        <td>
                            <span th:if="${account.status == 1}">Hoạt động</span>
                            <span th:if="${account.status == 0}">Ngưng hoạt động</span>
                        </td>
                        <td class="d-flex justify-content-evenly">
                            <button type="button" class="btn btn-warning btn-sm" th:attr="data-id=${account.accountId}" onclick="editAccount(this)">Chỉnh sửa</button>
                            <button type="button" class="btn btn-danger btn-sm" 
                                    th:attr="data-id=${account.accountId}, disabled=${account.status == 0 ? 'disabled' : null}" 
                                    onclick="deleteAccount(this)">Xóa</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal for Edit Account -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" id="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chỉnh Sửa Tài Khoản</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeModal()"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm" onsubmit="return false;">
                        <div class="mb-3">
                            <label for="accountName" class="form-label">Tên Tài Khoản</label>
                            <input type="text" class="form-control" id="accountName" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="status" class="form-label">Trạng Thái</label>
                            <select class="form-select" id="status" required>
                                <option value="1">Hoạt động</option>
                                <option value="0">Ngưng hoạt động</option>
                            </select>
                        </div>
                        <input type="hidden" id="accountId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeModal()">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="saveChanges()">Lưu thay đổi</button>
                </div>
            </div>
        </div>
    </div>
	<!-- Modal for Add Account -->
<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addModalLabel">Thêm Tài Khoản</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addForm" onsubmit="return false;">
                    <div class="mb-3">
                        <label for="newAccountName" class="form-label">Tên Tài Khoản</label>
                        <input type="text" class="form-control" id="newAccountName" required>
                    </div>
                    <div class="mb-3">
                        <label for="newEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="newEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">Trạng Thái</label>
                        <select class="form-select" id="newStatus" required>
                            <option value="1">Hoạt động</option>
                            <option value="0">Ngưng hoạt động</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="addAccount()">Thêm tài khoản</button> <!-- Nút Lưu -->
            </div>
        </div>
    </div>
</div>
	
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Thêm jQuery từ CDN -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    function showAlert(type, message) {
        const alertBox = document.createElement('div');
        alertBox.className = `alert alert-${type}`;
        alertBox.innerText = message;
        document.body.appendChild(alertBox);
        // Using vanilla JavaScript to fade out the alert
        alertBox.style.display = 'block';
        setTimeout(() => {
            alertBox.style.opacity = 0;
            setTimeout(() => {
                alertBox.remove();
            }, 600);
        }, 3000);
    }
    
    function loadAccounts() {
        fetch('/admin/accounts/listAccount') 
            .then(response => response.json())
            .then(data => {
                const tableContent = document.getElementById('table-content');
                tableContent.innerHTML = ''; // Xóa nội dung cũ

                data.forEach(account => {
                    const row = document.createElement('tr');

                    row.innerHTML = `
                        <td>${account.accountId}</td>
                        <td>${account.accountName}</td>
                        <td>${account.email}</td>
                        <td>
                            <span>${account.status == 1 ? 'Hoạt động' : 'Ngưng hoạt động'}</span>
                        </td>
                        <td class="d-flex justify-content-evenly">
                            <button type="button" class="btn btn-warning btn-sm" data-id="${account.accountId}" onclick="editAccount(this)">Chỉnh sửa</button>
                            <button type="button" class="btn btn-danger btn-sm" data-id="${account.accountId}" ${account.status == 0 ? 'disabled' : ''} onclick="deleteAccount(this)">Xóa</button>
                        </td>
                    `;

                    tableContent.appendChild(row);
                });
            })
            .catch(error => {
                console.error('Lỗi khi tải dữ liệu:', error);
            });
    }

    function filterAccounts() {
        const searchInput = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const tableRows = document.querySelectorAll('#table-content tr');

        tableRows.forEach(row => {
            const accountName = row.cells[1].innerText.toLowerCase();
            const status = row.cells[3].innerText.toLowerCase();
            const matchesSearch = accountName.includes(searchInput);
            const matchesStatus = statusFilter === '' || (statusFilter === '1' && status === 'hoạt động') || (statusFilter === '0' && status === 'ngưng hoạt động');

            if (matchesSearch && matchesStatus) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }


    function addAccount() {
        const accountName = document.getElementById('newAccountName').value;
        const email = document.getElementById('newEmail').value;
        const status = document.getElementById('newStatus').value;

        // Kiểm tra dữ liệu
        if (!accountName || !email) {
            showAlert('danger', 'Vui lòng điền đầy đủ thông tin!');
            return;
        }

        // Kiểm tra định dạng email
        if (!isValidEmail(email)) {
            showAlert('danger', 'Vui lòng nhập địa chỉ email hợp lệ!');
            return;
        }

        const accountData = {
            accountName: accountName,
            email: email,
            status: status
        };

        fetch('/admin/accounts/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(accountData)
        })
        .then(response => {
            if (response.ok) {
                showAlert('success', 'Thêm tài khoản thành công!');
                loadAccounts(); // Tải lại danh sách tài khoản
                document.getElementById('addForm').reset(); // Reset form
                const addModal = bootstrap.Modal.getInstance(document.getElementById('addModal'));
                addModal.hide(); // Đóng modal
            } else {
                showAlert('danger', 'Thêm tài khoản thất bại!');
            }
        })
        .catch(error => {
            console.error('Lỗi khi thêm tài khoản:', error);
            showAlert('danger', 'Đã xảy ra lỗi khi thêm tài khoản!');
        });
    }

    // Hàm kiểm tra định dạng email
    function isValidEmail(email) {
        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; // Định dạng email cơ bản
        return regex.test(email);
    }


    function deleteAccount(button) {
        const accountId = button.getAttribute('data-id');
        const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));

        document.getElementById('confirmDeleteButton').onclick = function() {
            fetch(`/admin/accounts/delete/${accountId}`, { method: 'DELETE' })
                .then(response => {
                    if (response.ok) {
                        showAlert('success', 'Xóa tài khoản thành công!');
                        // Disable the delete button instead of removing the row
                        loadAccounts()
                    } else {
                        showAlert('danger', 'Xóa tài khoản thất bại!');
                    }
                    confirmDeleteModal.hide();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('danger', 'Có lỗi xảy ra!');
                    confirmDeleteModal.hide();
                });
        };
        confirmDeleteModal.show();
    }

    function editAccount(button) {
        const accountId = button.getAttribute('data-id');
        fetch(`/admin/accounts/${accountId}`)
            .then(response => response.json())
            .then(account => {
                document.getElementById('accountId').value = account.accountId;
                document.getElementById('accountName').value = account.accountName;
                document.getElementById('email').value = account.email;
                document.getElementById('status').value = account.status;

                const editModal = new bootstrap.Modal(document.getElementById('editModal'));
                editModal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('danger', 'Có lỗi xảy ra khi lấy thông tin tài khoản!');
            });
    }
    

    function closeModal() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
        if (modal) modal.hide();
    }

    function saveChanges() {
        const accountId = document.getElementById('accountId').value;
        const accountName = document.getElementById('accountName').value;
        const email = document.getElementById('email').value;
        const status = document.getElementById('status').value;

        // Kiểm tra dữ liệu
        if (!accountId || !accountName || !email) {
            showAlert('danger', 'Vui lòng điền đầy đủ thông tin!');
            return;
        }

        // Kiểm tra định dạng email
        if (!isValidEmail(email)) {
            showAlert('danger', 'Vui lòng nhập địa chỉ email hợp lệ!');
            return;
        }

        // Hiển thị modal xác nhận
        const confirmSaveButton = document.getElementById('confirmSaveButton');
        confirmSaveButton.onclick = function() {
            fetch(`/admin/accounts/update/${accountId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    accountId: accountId,
                    accountName: accountName,
                    email: email,
                    status: status
                })
            })
            .then(response => {
                if (response.ok) {
                    showAlert('success', 'Lưu thay đổi thành công!');
                    loadAccounts();
                    closeModal(); // Đóng modal sau khi lưu thành công
                } else {
                    showAlert('danger', 'Lưu thay đổi thất bại!');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('danger', 'Có lỗi xảy ra khi lưu thay đổi!');
            });

            // Đóng modal sau khi xác nhận lưu
            $('#confirmSaveModal').modal('hide');
        };

        // Mở modal xác nhận
        $('#confirmSaveModal').modal('show');
    }


    </script>
</body>
</html>
